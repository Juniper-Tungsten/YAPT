<!DOCTYPE html>
<html lang="en">

<head>
    <title>YAPT OOBA</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>

<style>
form {
    border: 3px solid #f1f1f1;
}

input[type=text] {
    width: 100%;
    padding: 12px 20px;
    margin: 8px 0;
    display: inline-block;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

.btn {
    padding: 14px 20px;
    margin: 8px 0;
    border: none;
    cursor: pointer;
    width: 100%;
}

.btn:hover {
    opacity: 0.9;
}

.btn-primary {
    background-color: #1f567a;
    color: white;
}

.container {
    padding: 16px;
}

span.psw {
    float: right;
    padding-top: 16px;
}

.table thead th {
  background-color: #70868f;
}

</style>

<body>
<div class="container">
    <h2 class="text-center">Out Of Band Activation</h2>

    <div class="jumbotron" id="main">
        <div class="panel panel-default">
            <div class="panel-heading">Site Identification</div>
            <div class="panel-body">
                <input type="text" id=input_siteid placeholder="Enter Site ID" name="siteid" required>
                <button type="button" id="b_send_id" class="btn btn-primary">Start</button>
            </div>
            <div class="panel-footer">YAPT OOBA</div>
        </div>
    </div>
</div>

<div class="modal fade" id="provision" tabindex="-1" role="dialog" aria-labelledby="provision" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span
                        class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                <h4 class="modal-title custom_align" id="Heading">Activation Status</h4>
            </div>
            <div class="modal-body" id="activateStatus">
            </div>
            <div class="modal-footer ">
                <button type="button" class="btn btn-primary btn-lg" style="width: 100%;"><span
                        class="glyphicon glyphicon-ok-sign"></span>Â Close
                </button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script>

    var host = "{{ host }}";
    var port = "{{ port }}";

    $(document).ready(function() {
        $("#b_send_id").on('click', function (e) {
            getSiteData($("#input_siteid").val());
        });
    });

    function getSiteData(siteId) {

        function fetch() {
            $.ajax({
                async: true,
                crossDomain: true,
                url: "http://" + host + ":" + port + "/api/site?siteId=" + siteId,
                method: "GET",
                dataType: "text",
                success: function (response) {
                    var site = jQuery.parseJSON(response);
                    prepareSiteContent(site);
                },
                error : function (data, errorText) {
                    $("#errormsg").html(errorText).show();
                }
            });
        }
        fetch();
    }

    function updateAssetMapping(data){
        function fetch() {
            $.ajax({
                async: true,
                crossDomain: true,
                url: "http://" + host + ":" + port + "/api/asset?action=update",
                method: "POST",
                contentType: "application/json",
                processData: false,
                data: JSON.stringify(data),
                success: function (response) {
                    $("#activateStatus").append('Mapping: <span class=\"glyphicon glyphicon-ok\"></span>');

                },
                error : function (data, errorText) {
                    $("#errormsg").html(errorText).show();
                    $("#activateStatus").append('Mapping: <span class=\"glyphicon glyphicon-remove\"></span><br/>');
                }
            });
        }
        fetch();
    }

    function authenticateAsset(assetSerial){

        function fetch() {
                $.ajax({
                    async: true,
                    crossDomain: true,
                    url: "http://" + host + ":" + port + "/api/authenticate?sn=" + assetSerial,
                    method: "POST",
                    success: function (response) {
                        $("#activateStatus").append('Authentication: <span class=\"glyphicon glyphicon-ok\"></span><br/>');

                    },
                    error : function (data, errorText) {
                        $("#errormsg").html(errorText).show();
                        $("#activateStatus").append('Authentication: <span class=\"glyphicon glyphicon-remove\"></span><br/>');
                    }
                });
            }
            fetch();
    }

    function prepareSiteContent(site){

        var siteContent = "";
        var newAssetRow = "";

        $.each(site.assets, function(k, v) {
            tempRow = '<tr id=' + v.assetConfigId + '><td contenteditable=\"true\">' + v.assetSerial + '</td><td>' + v.assetDescr + '</td>' +
            '<td><p data-placement=\"top\" data-toggle=\"tooltip\" title=\"Provision\"><button class=\"btn btn-primary btn-xs\" onclick=\"initProv(\''+v.assetSerial+'\',\''+v.assetConfigId+'\')\" data-title=\"Provision\" data-toggle=\"modal\" data-target=\"#provision\"><span class=\"glyphicon glyphicon-pencil\"></span></button></p></td></tr>';
            newAssetRow += tempRow;
        });

        siteContent +=
        "<h4>" + site.siteName + "</h4>" +
        "<h5>" + site.siteId + "</h5>" +
        "<h5>" + site.siteDescr + "</h5>" +
            "<table id=\"assets\" class=\"table table-striped table-responsive \">" +
                    "<thead>" +
                    "<tr>" +
                        "<th class=\"th1\">Asset Serial</th>" +
                        "<th class=\"th3\">Description</th>" +
                        "<th class=\"th4\">Activate</th>" +
                    "</tr>" +
                    "</thead>" +
                    "<tbody>" +
                        newAssetRow
                    "</tbody>" +
                "</table>"

        $("#main").empty();
        $("#main").append(siteContent);
    }

    function initProv(assetSerial, assetConfigId){
        var data = { "assetSerial": assetSerial, "assetConfigId": assetConfigId};
        $("#activateStatus").empty();
        updateAssetMapping(data);
        authenticateAsset(assetSerial);
    }
</script>
</body>
</html>